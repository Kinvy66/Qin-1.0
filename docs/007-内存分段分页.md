# 内存
内存的访问方式有分段和分页，其大致流程如下：
![](./images/fig7-1.png)


## 1. 内存分段
内存分段的基本思想就是 `段基址:偏移地址 = 虚拟地址` 段基址保存在段寄存器，无论实模式还是保护模式段寄存器都是16bit。


### 实模式的分段
实模的中，`段基址:偏移地址` 对应的地址是 `段基址*16 + 偏移地址` ,该地址就是物理地址，无须再进一步的转换


### 保护模式下的分段
保护模式下的内存分段是需要先定义一个GDT（全局描述符表），GDT的每一个表项（GD， 描述符）就是一个内存段。每个描述符是8个字节，描述了内存段的起始位置，偏移位置，段属性等信息。GDT在内存中的位置保存在`gdtr` 寄存器中。


保护模式下，段寄存器又叫段选择子，它给出了的是段在GDT中的索引值以及权限和GDT/LDT：
![](./images/fig7-2.png)

`偏移地址` 是段内的偏移，因此保护模式下的分段流程:
![](./images/fig7-3.png)

在没有开启分页的情况下，线性地址直接对应物理地址

## 2. 内存分页
内存分页功能开启是将控制寄存器 `CR0` 的 `PG` 位置1。


二级页表示意图, 页目录表和页表的每个表项都是4个字节，每个物理页是4KB：
![](./images/fig7-4.png)


页目录表和页表的表项内容：
![](./images/fig7-5.png)



开启分页机制后，线性地址到物理地址的转换:
![](./images/fig7-6.png)


`CR3` 寄存器是保存页目录表的物理地址


## 物理内存分布情况

![](./images/mem-layout-1mb.drawio.png)




## 页目录和页表的设计
将页目录表和页表放在连续的内存中，页目录表的起始地址`0x100000(1MB)`，第一个页表的物理地址：`0x101000`.

![Alt text](./images/fig7-7.png)


## 本系统页目录和页表设计
进程虚拟内存的分布，高地址(3GB~4GB)是内核空间，低地址(0~3GB)是用户程序空间，其中包括用户代码，堆栈空间。  
页目录表和页表本身是数据，它们需要存储空间，本系统页目录表放在物理地址0x100000的位置，1024个页目录表表项占用4KB.紧随其后的是页表(0x101000)，共有1024个页表，每个页表有1024个表项，占用 1024x1024x4Byte = 4MB 的空间 .

